<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réinitialiser le Mot de Passe - BHCARS</title>
    <link rel="icon" type="image/png" href="assets/images/logo-location2.png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="css/login.css" rel="stylesheet">
</head>
<body class="bg-light d-flex align-items-center justify-content-center min-vh-100">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-6">
                <div class="card shadow-lg border-0 overflow-hidden">
                    <div class="card-body p-5 text-center">
                        <div class="mb-4">
                            <img src="assets/images/logo-location2.png" alt="BHCARS Logo" style="height: 60px;">
                        </div>
                        
                        <h2 class="mb-4 fw-bold text-dark">Réinitialiser le Mot de Passe</h2>
                        
                        <form id="reset-password-form">
                            <div class="form-floating mb-3">
                                <input 
                                    type="password" 
                                    class="form-control" 
                                    id="new-password" 
                                    placeholder="Nouveau mot de passe"
                                    required
                                    minlength="6">
                                <label for="new-password">
                                    <i class="fas fa-lock"></i> Nouveau Mot de Passe
                                </label>
                                <small class="form-text text-muted d-block mt-1">Minimum 6 caractères</small>
                            </div>

                            <div class="form-floating mb-4">
                                <input 
                                    type="password" 
                                    class="form-control" 
                                    id="confirm-password" 
                                    placeholder="Confirmer le mot de passe"
                                    required
                                    minlength="6">
                                <label for="confirm-password">
                                    <i class="fas fa-lock"></i> Confirmer le Mot de Passe
                                </label>
                            </div>

                            <p id="reset-error" class="text-danger small mb-3"></p>
                            <p id="reset-success" class="text-success small mb-3"></p>

                            <button 
                                type="submit" 
                                class="btn btn-gold w-100 fw-bold py-2 mb-3">
                                <i class="fas fa-check me-2"></i>Réinitialiser le Mot de Passe
                            </button>

                            <div class="text-center">
                                <p class="text-muted">
                                    Vous vous souvenez de votre mot de passe? 
                                    <a href="index.html" class="text-decoration-none fw-bold text-gold">
                                        Se connecter
                                    </a>
                                </p>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/types.js?v=99"></script>
    <script src="js/data.js?v=99"></script>
    <script src="js/crud.js?v=99"></script>
    <script>
        console.log('=== Script reset-password.html chargé ===');
        console.log('getDb:', typeof getDb);
        console.log('updateItem:', typeof updateItem);
        console.log('getAllItems:', typeof getAllItems);
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DOMContentLoaded déclenché ===');
            
            // Vérification des dépendances
            if (typeof getDb === 'undefined' || typeof updateItem === 'undefined') {
                console.error("Erreur: Les scripts de base sont manquants.");
                console.error("getDb:", typeof getDb, "updateItem:", typeof updateItem, "getAllItems:", typeof getAllItems);
                document.getElementById('reset-error').textContent = 'Erreur: Scripts manquants';
                document.getElementById('reset-password-form').style.display = 'none';
                return;
            }

            // Récupérer le token de l'URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const errorEl = document.getElementById('reset-error');
            const successEl = document.getElementById('reset-success');
            const form = document.getElementById('reset-password-form');
            const submitBtn = form.querySelector('button[type="submit"]');

            // Vérifier si le token est valide
            if (!token) {
                console.error('❌ Token non trouvé dans l\'URL');
                errorEl.textContent = 'Token de réinitialisation manquant.';
                form.style.display = 'none';
                return;
            }

            try {
                // Récupérer les données du token depuis la BASE DE DONNÉES
                console.log('Token extrait de l\'URL:', token);
                
                // ⚠️ IMPORTANT : Appeler getDb() pour s'assurer que resetTokens existe
                const db = getDb();
                console.log('=== État de la Base de Données ===');
                console.log('Entités disponibles:', Object.keys(db));
                console.log('resetTokens existe?', db.resetTokens ? 'OUI' : 'NON');
                
                if (!db.resetTokens) {
                    console.error('❌ ERREUR: resetTokens n\'existe pas dans la BD!');
                    errorEl.textContent = 'Erreur système: collection resetTokens introuvable.';
                    form.style.display = 'none';
                    return;
                }
                
                const allResetTokens = getAllItems('resetTokens');
                console.log('Tous les tokens dans resetTokens:', allResetTokens);
                console.log('Nombre de tokens:', allResetTokens.length);
                
                const resetData = allResetTokens.find(rt => rt.token === token);
                console.log('Token cherché (token === token):', resetData);
                
                // Alternative : chercher par ID au cas où
                if (!resetData) {
                    console.log('Token non trouvé par propriété "token", essai par "id"...');
                    const resetDataById = allResetTokens.find(rt => rt.id === token);
                    console.log('Token trouvé par ID:', resetDataById);
                }
                
                if (!resetData) {
                    console.error('❌ Token non trouvé dans la BD');
                    errorEl.textContent = 'Le lien de réinitialisation est invalide ou expiré.';
                    form.style.display = 'none';
                    return;
                }

                // Vérifier l'expiration
                console.log('=== Vérification Expiration ===');
                console.log('Date actuelle:', Date.now());
                console.log('Date expiration:', resetData.expiresAt);
                console.log('Différence (ms):', resetData.expiresAt - Date.now());
                console.log('Différence (heures):', ((resetData.expiresAt - Date.now()) / (1000 * 3600)).toFixed(2));
                
                if (Date.now() > resetData.expiresAt) {
                    console.error('❌ Token expiré');
                    const expirationDate = new Date(resetData.expiresAt).toLocaleString('fr-FR');
                    errorEl.textContent = `Le lien de réinitialisation a expiré (valide jusqu'à ${expirationDate}). Veuillez faire une nouvelle demande.`;
                    form.style.display = 'none';
                    deleteItem('resetTokens', resetData.id);
                    return;
                }
                
                console.log('✅ Token valide! Formulaire affiché.');
                form.style.display = 'block';  // S'assurer que le formulaire est visible

                // Traiter la soumission du formulaire
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    errorEl.textContent = '';
                    successEl.textContent = '';

                    const newPassword = document.getElementById('new-password').value;
                    const confirmPassword = document.getElementById('confirm-password').value;

                    // Validations
                    if (newPassword.length < 6) {
                        errorEl.textContent = 'Le mot de passe doit contenir au moins 6 caractères.';
                        return;
                    }

                    if (newPassword !== confirmPassword) {
                        errorEl.textContent = 'Les mots de passe ne correspondent pas.';
                        return;
                    }

                    // Récupérer l'utilisateur par email
                    const db = getDb();
                    console.log('Tous les clients:', db.clients);
                    console.log('Recherche de email:', resetData.email);
                    const user = db.clients.find(c => c.email === resetData.email);
                    console.log('Utilisateur trouvé:', user);

                    if (!user) {
                        errorEl.textContent = 'Utilisateur non trouvé.';
                        return;
                    }

                    // Mettre à jour le mot de passe
                    const updatedUser = { ...user, password: newPassword };
                    console.log('Utilisateur à mettre à jour:', updatedUser);
                    const result = updateItem('clients', updatedUser);
                    console.log('Résultat updateItem:', result);

                    if (result) {
                        successEl.textContent = 'Mot de passe réinitialisé avec succès!';
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Mot de passe réinitialisé';

                        // Nettoyer le token
                        deleteItem('resetTokens', resetData.id);
                        console.log('✅ Token supprimé après réinitialisation');

                        // Redirection après 2 secondes
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 2000);
                    } else {
                        errorEl.textContent = 'Erreur lors de la mise à jour du mot de passe.';
                    }
                });
            } catch (error) {
                console.error('Erreur:', error);
                errorEl.textContent = 'Erreur lors du traitement de la demande.';
                form.style.display = 'none';
            }
        });
    </script>
</body>
</html>
